{{ if (eq .chezmoi.os "darwin") -}}
#!/usr/bin/env bash

set -eufo pipefail

# assembled from:
# https://github.com/mathiasbynens/dotfiles/blob/main/.macos
# https://github.com/webpro/dotfiles/blob/master/macos/defaults.sh 
# https://github.com/webpro/dotfiles/blob/master/macos/defaults.sh 
# https://git.coop/javi/dotfiles/-/blob/master/macos/defaults.sh  
# https://nhoffman.github.io/borborygmi/tag/mac.html 
# https://www.swyx.io/new-mac-setup-2021 
# https://github.com/samoshkin/dotfiles


# ======================================
# Computer name
# ======================================

echo "Applying MacOS settings"

COMPUTER_NAME={{ .hostname }}
echo "Using computer name: $COMPUTER_NAME"

# Ask for the administrator password up front, and use keep-alive for sudo
sudo -v

# Keep-alive: update existing `sudo` time stamp until this script has finished
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

osascript -e 'tell application "System Preferences" to quit'

# Set computer name (as done via System Preferences → Sharing)
sudo scutil --set ComputerName "$COMPUTER_NAME"
sudo scutil --set HostName "$COMPUTER_NAME"
sudo scutil --set LocalHostName "$COMPUTER_NAME"
sudo defaults write /Library/Preferences/SystemConfiguration/com.apple.smb.server NetBIOSName -string "$COMPUTER_NAME"

# ===================
# General
# ===================

# TODO need to get script way to turn off control-space shortcut in macos
# https://stackoverflow.com/questions/20245652/how-to-unbind-command-control-space-key-from-mac-os-x-10-9#answer-42668983

# Set finder sidebar icon size to medium
defaults write NSGlobalDomain NSTableViewDefaultSizeMode -int 2

# Disable automatic termination of inactive apps
defaults write -g NSDisableAutomaticTermination -bool true

# Save to disk (not to iCloud) by default
defaults write NSGlobalDomain NSDocumentSaveNewDocumentsToCloud -bool false

# Reveal IP address, hostname, OS version, etc. when clicking the clock in the login window
sudo defaults write /Library/Preferences/com.apple.loginwindow AdminHostInfo HostName

# Resume apps/windows system-wide
defaults write com.apple.systempreferences NSQuitAlwaysKeepsWindows -bool true

# Expand save panel by default
defaults write -g NSNavPanelExpandedStateForSaveMode -bool true
defaults write -g NSNavPanelExpandedStateForSaveMode2 -bool true

# Expand print panel by default
defaults write NSGlobalDomain PMPrintingExpandedStateForPrint -bool true
defaults write NSGlobalDomain PMPrintingExpandedStateForPrint2 -bool true

# Always show scrollbars
defaults write NSGlobalDomain AppleShowScrollBars -string "Always"

# Set Help Viewer windows to non-floating mode
defaults write com.apple.helpviewer DevMode -bool true

# =====================
# Menu bar
# =====================

defaults write com.apple.systemuiserver menuExtras -array \
"/System/Library/CoreServices/Menu Extras/AirPort.menu" \
"/System/Library/CoreServices/Menu Extras/Bluetooth.menu" \
"/System/Library/CoreServices/Menu Extras/Clock.menu" \
"/System/Library/CoreServices/Menu Extras/Volume.menu"
killall SystemUIServer

# =====================
# Quarantine
# =====================

# Enable applications installed from Internet to run without restrictions
# Then go to System Preferences -> Security and Privacy. And enable "Run applications -> Allow from anywhere"
sudo spctl --master-disable

# Enable the “Are you sure you want to open this application?” dialog
defaults write com.apple.LaunchServices LSQuarantine -bool false

# ===========================
# Power Management
# ===========================

# on power
sudo pmset -c displaysleep 20
sudo pmset -c sleep 21
sudo pmset -c disksleep 62

# on battery
sudo pmset -b displaysleep 5
sudo pmset -b sleep 6
sudo pmset -b disksleep 10

# Wake up the machine when lid is opened
sudo pmset -a lidwake 1

# disable display sleep to use an intermediate half-brightness state between full brightness and fully off  (value = 0/1)
# just make it fully off
sudo pmset -a halfdim 0

# disable screen saver
defaults -currentHost write com.apple.screensaver idleTime 0

# =======================
# Keyboard
# =======================

# increase key repeat rate
defaults write NSGlobalDomain KeyRepeat -int 1
defaults write NSGlobalDomain InitialKeyRepeat -int 15


defaults write NSGlobalDomain AppleInterfaceStyle Dark
defaults write NSGlobalDomain AppleLanguages -array en-US
defaults write NSGlobalDomain AppleLocale en_US

# Disable automatic capitalization as it’s annoying when typing code
defaults write NSGlobalDomain NSAutomaticCapitalizationEnabled -bool false

# Disable automatic period substitution as it’s annoying when typing code
defaults write NSGlobalDomain NSAutomaticPeriodSubstitutionEnabled -bool false

# Disable smart quotes as they’re annoying when typing code
defaults write NSGlobalDomain NSAutomaticQuoteSubstitutionEnabled -bool false

# Disable smart dashes as they’re annoying when typing code
defaults write NSGlobalDomain NSAutomaticDashSubstitutionEnabled -bool false

# Disable auto-correct
defaults write NSGlobalDomain NSAutomaticSpellingCorrectionEnabled -bool false

# Enable full keyboard access for all controls
# (e.g. enable Tab in modal dialogs)
defaults write NSGlobalDomain AppleKeyboardUIMode -int 3

# Use scroll gesture with the Ctrl (^) modifier key to zoom
# defaults write com.apple.universalaccess closeViewScrollWheelToggle -bool true

# Follow the keyboard focus while zoomed in
# defaults write com.apple.universalaccess closeViewZoomFollowsFocus -bool true


defaults write NSGlobalDomain NSAutomaticTextCompletionEnabled -bool false
defaults write NSGlobalDomain NSLinguisticDataAssetsRequested -array en en_US
#defaults write NSGlobalDomain NSUserDictionaryReplacementItems -array
defaults write NSGlobalDomain WebAutomaticSpellingCorrectionEnabled -bool false

# SCROLL DIRECTION
#defaults write NSGlobalDomain com.apple.swipescrolldirection -bool false


# Enable full keyboard access for all controls
# (e.g. enable Tab in modal dialogs)
defaults write NSGlobalDomain AppleKeyboardUIMode -int 3

# ===========================
# TrackPad & Mouse
# ===========================

# Trackpad: enable tap to click for this user and for the login screen
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true
defaults -currentHost write NSGlobalDomain com.apple.mouse.tapBehavior -int 1
defaults write NSGlobalDomain com.apple.mouse.tapBehavior -int 1

# Disable “natural” (Lion-style) scrolling
# defaults write NSGlobalDomain com.apple.swipescrolldirection -bool false

# drag with three fingers
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadThreeFingerDrag -int 1

# Mouse sensitivity
defaults write NSGlobalDomain com.apple.mouse.scaling -float 1.5
defaults write NSGlobalDomain com.apple.scrollwheel.scaling -float 0.1265



# defaults write -g ApplePressAndHoldEnabled -bool false

defaults write com.apple.finder _FXShowPosixPathInTitle -bool true

# =================================
# Mac App Store 
# =================================

# Enable the WebKit Developer Tools in the Mac App Store
defaults write com.apple.appstore WebKitDeveloperExtras -bool true

defaults write com.apple.SoftwareUpdate AutomaticCheckEnabled -bool true
defaults write com.apple.SoftwareUpdate ScheduleFrequency -int 1
defaults write com.apple.SoftwareUpdate AutomaticDownload -int 1
defaults write com.apple.SoftwareUpdate CriticalUpdateInstall -int 1
#defaults write com.apple.systempreferences NSQuitAlwaysKeepsWindows -bool false

# Turn on app auto-update
defaults write com.apple.commerce AutoUpdate -bool true

# ===========================
# Dock , Dashboard
# ===========================

# Set the icon size of Dock items
defaults write com.apple.dock tilesize -int 44
defaults write com.apple.dock largesize -int 72

# Keep Dock on the right side
defaults write com.apple.dock orientation -string "right"

# Show indicator lights for open applications in the Dock
defaults write com.apple.dock "show-process-indicators" -int 1

defaults write com.apple.dock "trash-full" -int 1

# Automatically hide and show the Dock
defaults write com.apple.dock autohide -bool true

# Show hidden apps in a Dock
defaults write com.apple.dock showhidden -bool true

# Use magnigification when hovering mouse over the icon
defaults write com.apple.dock magnification -int 1

# Change minimize/maximize window effect
defaults write com.apple.dock mineffect -string "scale"

# Don’t animate opening applications from the Dock
defaults write com.apple.dock launchanim -bool false

# Disable Dashboard
defaults write com.apple.dashboard mcx-disabled -bool true

# Don’t automatically rearrange Spaces based on most recent use
defaults write com.apple.dock mru-spaces -bool false

# Show recent applications in Dock
defaults write com.apple.dock show-recents -bool false


# make dock hide a long time; unhide with command-option-D 
# according to https://apple.stackexchange.com/questions/59556/is-there-a-way-to-completely-disable-dock
defaults write com.apple.dock autohide-delay -float 6; killall Dock
defaults write com.apple.Dock appswitcher-all-displays -bool true; killall Dock

# ======================================
# Activity monitor
# ======================================

# Show the main window when launching Activity Monitor
defaults write com.apple.ActivityMonitor OpenMainWindow -bool true

# Show all processes in Activity Monitor
defaults write com.apple.ActivityMonitor ShowCategory -int 0

# Sort Activity Monitor results by CPU usage
defaults write com.apple.ActivityMonitor SortColumn -string "CPUUsage"
defaults write com.apple.ActivityMonitor SortDirection -int 0

# Enable the WebKit Developer Tools in the Mac App Store
defaults write com.apple.appstore WebKitDeveloperExtras -bool true

defaults write com.apple.SoftwareUpdate AutomaticCheckEnabled -bool true
defaults write com.apple.SoftwareUpdate ScheduleFrequency -int 1
defaults write com.apple.SoftwareUpdate AutomaticDownload -int 1
defaults write com.apple.SoftwareUpdate CriticalUpdateInstall -int 1


# ======================================
# Notifications
# ======================================

# todo how to make notifications turn off almost always?
# launchctl unload -w /System/Library/LaunchAgents/com.apple.notificationcenterui.plist 2> /dev/null

{{ end -}}
